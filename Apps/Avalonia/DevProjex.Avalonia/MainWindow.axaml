<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:DevProjex.Avalonia.ViewModels"
        xmlns:views="using:DevProjex.Avalonia.Views"
        xmlns:converters="using:DevProjex.Avalonia.Converters"
        x:Class="DevProjex.Avalonia.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        Title="{Binding Title}"
        Icon="avares://DevProjex/AppIcon/icon-256.png"
        Width="1200" Height="800"
        MinWidth="800" MinHeight="600"
        TransparencyLevelHint="Mica, AcrylicBlur, Blur"
        Background="{DynamicResource AppBackgroundBrush}">
  <Window.Styles>
    <Style Selector="TreeViewItem">
      <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}" />
      <Setter Property="IsSelected" Value="{Binding IsSelected, Mode=TwoWay}" />
      <Setter Property="Padding"
              Value="{Binding DataContext.TreeItemPadding, RelativeSource={RelativeSource AncestorType=TreeView}}" />
    </Style>
    <!-- Fix for virtualization cache bug: the :empty pseudo-class may not update correctly
         when VirtualizingStackPanel recycles TreeViewItem containers. We use Opacity binding
         instead of IsVisible to hide the expander while preserving layout space for alignment. -->
    <Style Selector="TreeViewItem /template/ ToggleButton#PART_ExpandCollapseChevron">
      <Setter Property="Opacity" Value="{Binding DataContext.HasChildren,
        RelativeSource={RelativeSource AncestorType=TreeViewItem},
        Converter={x:Static converters:BoolToOpacityConverter.Instance}}" />
    </Style>

    <!-- Drop Zone Styles -->

    <!-- Dashed border animation around the drop zone -->
    <!-- Animation only runs when parent has "animating" class to save CPU when hidden -->
    <Style Selector="Rectangle.drop-zone-border">
      <Setter Property="Opacity" Value="1" />
      <Setter Property="StrokeDashOffset" Value="0" />
    </Style>
    <Style Selector="Border.drop-zone-animating Rectangle.drop-zone-border">
      <Style.Animations>
        <Animation Duration="0:0:0.8" IterationCount="INFINITE">
          <KeyFrame Cue="0%">
            <Setter Property="StrokeDashOffset" Value="0" />
          </KeyFrame>
          <KeyFrame Cue="100%">
            <Setter Property="StrokeDashOffset" Value="-14" />
          </KeyFrame>
        </Animation>
      </Style.Animations>
    </Style>

    <Style Selector="Viewbox.drop-zone-icon">
      <Setter Property="RenderTransformOrigin" Value="50%,50%" />
      <Setter Property="RenderTransform">
        <TranslateTransform Y="0" />
      </Setter>
    </Style>
    <Style Selector="Border.drop-zone-animating Viewbox.drop-zone-icon">
      <Style.Animations>
        <Animation Duration="0:0:1.7" IterationCount="INFINITE">
          <KeyFrame Cue="0%">
            <Setter Property="TranslateTransform.Y" Value="0" />
          </KeyFrame>
          <KeyFrame Cue="12.5%">
            <Setter Property="TranslateTransform.Y" Value="3.89" />
          </KeyFrame>
          <KeyFrame Cue="25%">
            <Setter Property="TranslateTransform.Y" Value="5.5" />
          </KeyFrame>
          <KeyFrame Cue="37.5%">
            <Setter Property="TranslateTransform.Y" Value="3.89" />
          </KeyFrame>
          <KeyFrame Cue="50%">
            <Setter Property="TranslateTransform.Y" Value="0" />
          </KeyFrame>
          <KeyFrame Cue="62.5%">
            <Setter Property="TranslateTransform.Y" Value="-3.89" />
          </KeyFrame>
          <KeyFrame Cue="75%">
            <Setter Property="TranslateTransform.Y" Value="-5.5" />
          </KeyFrame>
          <KeyFrame Cue="87.5%">
            <Setter Property="TranslateTransform.Y" Value="-3.89" />
          </KeyFrame>
          <KeyFrame Cue="100%">
            <Setter Property="TranslateTransform.Y" Value="0" />
          </KeyFrame>
        </Animation>
      </Style.Animations>
    </Style>

    <Style Selector="Border.drop-zone-outer:pointerover Rectangle.drop-zone-border">
      <Setter Property="StrokeThickness" Value="3" />
      <Setter Property="Margin" Value="-1.5" />
      <Setter Property="RadiusX" Value="21.5" />
      <Setter Property="RadiusY" Value="21.5" />
    </Style>

    <!-- Drop zone button with smooth transitions -->
    <Style Selector="Button.drop-zone-button">
      <Setter Property="Opacity" Value="1" />
      <Setter Property="Transitions">
        <Transitions>
          <DoubleTransition Property="Opacity" Duration="0:0:0.25" Easing="CubicEaseInOut" />
        </Transitions>
      </Setter>
    </Style>

    <Style Selector="Button.drop-zone-button:pointerover">
      <Setter Property="Opacity" Value="1" />
    </Style>

    <Style Selector="Button.drop-zone-button:pressed">
      <Setter Property="Opacity" Value="0.92" />
    </Style>

    <Style Selector="Border.island-panel">
      <Setter Property="Background" Value="{DynamicResource AppPanelBrush}" />
      <Setter Property="BorderBrush" Value="{DynamicResource AppBorderBrush}" />
      <Setter Property="BorderThickness" Value="1" />
      <Setter Property="CornerRadius" Value="12" />
      <Setter Property="ClipToBounds" Value="True" />
    </Style>

    <Style Selector="Border.content-island">
      <Setter Property="Padding" Value="0" />
    </Style>

    <Style Selector="Border.content-island TreeView">
      <Setter Property="BorderThickness" Value="0" />
      <Setter Property="Background" Value="Transparent" />
    </Style>

    <Style Selector="Border.settings-island">
      <Setter Property="Padding" Value="0" />
    </Style>

    <Style Selector="Border.status-strip">
      <Setter Property="Background" Value="{DynamicResource AppPanelBrush}" />
      <Setter Property="BorderBrush" Value="{DynamicResource AppBorderBrush}" />
      <Setter Property="BorderThickness" Value="0,1,0,0" />
      <Setter Property="Padding" Value="10,5" />
    </Style>

    <Style Selector="ProgressBar.status-progress">
      <Setter Property="Height" Value="4" />
      <Setter Property="MinWidth" Value="120" />
      <Setter Property="MaxWidth" Value="170" />
      <Setter Property="Foreground" Value="{DynamicResource AppAccentBrush}" />
      <Setter Property="Background" Value="{DynamicResource AppBorderBrush}" />
    </Style>

    <Style Selector="Button.status-cancel">
      <Setter Property="Background" Value="Transparent" />
      <Setter Property="BorderThickness" Value="0" />
      <Setter Property="Padding" Value="0" />
      <Setter Property="MinWidth" Value="16" />
      <Setter Property="MinHeight" Value="16" />
      <Setter Property="Width" Value="16" />
      <Setter Property="Height" Value="16" />
      <Setter Property="Cursor" Value="Hand" />
    </Style>
  </Window.Styles>

  <DockPanel LastChildFill="True">
    <views:TopMenuBarView DockPanel.Dock="Top"
                          Name="TopMenuBar"
                          OpenFolderRequested="OnOpenFolder"
                          RefreshRequested="OnRefresh"
                          ExportTreeToFileRequested="OnExportTreeToFile"
                          ExportContentToFileRequested="OnExportContentToFile"
                          ExportTreeAndContentToFileRequested="OnExportTreeAndContentToFile"
                          ExitRequested="OnExit"
                          CopyTreeRequested="OnCopyTree"
                          CopyContentRequested="OnCopyContent"
                          CopyTreeAndContentRequested="OnCopyTreeAndContent"
                          ExpandAllRequested="OnExpandAll"
                          CollapseAllRequested="OnCollapseAll"
                          ZoomInRequested="OnZoomIn"
                          ZoomOutRequested="OnZoomOut"
                          ZoomResetRequested="OnZoomReset"
                          ToggleCompactModeRequested="OnToggleCompactMode"
                          ToggleTreeAnimationRequested="OnToggleTreeAnimation"
                          ToggleSearchRequested="OnToggleSearch"
                          ToggleSettingsRequested="OnToggleSettings"
                          TogglePreviewRequested="OnTogglePreview"
                          ToggleFilterRequested="OnToggleFilter"
                          ThemeMenuClickRequested="OnThemeMenuClick"
                          HelpRequested="OnHelp"
                          HelpCloseRequested="OnHelpClose"
                          LanguageRuRequested="OnLangRu"
                          LanguageEnRequested="OnLangEn"
                          LanguageUzRequested="OnLangUz"
                          LanguageTgRequested="OnLangTg"
                          LanguageKkRequested="OnLangKk"
                          LanguageFrRequested="OnLangFr"
                          LanguageDeRequested="OnLangDe"
                          LanguageItRequested="OnLangIt"
                          AboutRequested="OnAbout"
                          AboutCloseRequested="OnAboutClose"
                          AboutOpenLinkRequested="OnAboutOpenLink"
                          AboutCopyLinkRequested="OnAboutCopyLink"
                          ResetSettingsRequested="OnResetSettings"
                          SetLightThemeRequested="OnSetLightThemeCheckbox"
                          SetDarkThemeRequested="OnSetDarkThemeCheckbox"
                          SetTransparentModeRequested="OnSetTransparentMode"
                          SetMicaModeRequested="OnSetMicaMode"
                          SetAcrylicModeRequested="OnSetAcrylicMode"
                          GitCloneRequested="OnGitClone"
                          GitGetUpdatesRequested="OnGitGetUpdates"
                          GitBranchSwitchRequested="OnGitBranchSwitch" />

    <Border DockPanel.Dock="Bottom" Classes="status-strip" IsVisible="{Binding IsProjectLoaded}">
      <Grid ColumnDefinitions="Auto,*,Auto">
        <!-- Left: Tree metrics -->
        <StackPanel Grid.Column="0"
                    Orientation="Horizontal"
                    VerticalAlignment="Center"
                    IsVisible="{Binding StatusMetricsVisible}">
          <TextBlock Text="{Binding StatusTreeLabel}"
                     FontSize="12"
                     FontWeight="SemiBold"
                     Opacity="0.9"
                     VerticalAlignment="Center" />
          <TextBlock Text=" - "
                     FontSize="12"
                     Opacity="0.6"
                     VerticalAlignment="Center" />
          <TextBlock Text="{Binding StatusTreeStatsText}"
                     FontSize="12"
                     Foreground="{DynamicResource AppTextBrush}"
                     Opacity="0.88"
                     VerticalAlignment="Center" />
        </StackPanel>

        <!-- Center: Progress bar with operation text -->
        <StackPanel Grid.Column="1"
                    Orientation="Horizontal"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    Spacing="8"
                    IsVisible="{Binding StatusBusy}">
          <TextBlock Text="{Binding StatusOperationText}"
                     FontSize="12"
                     Opacity="0.8"
                     VerticalAlignment="Center" />
          <ProgressBar Classes="status-progress"
                       IsVisible="{Binding StatusProgressVisible}"
                       IsIndeterminate="{Binding StatusProgressIsIndeterminate}"
                       Value="{Binding StatusProgressValue}"
                       Minimum="0"
                       Maximum="100"
                       VerticalAlignment="Center" />
          <TextBlock Text="{Binding StatusProgressPercentText}"
                     IsVisible="{Binding StatusProgressPercentVisible}"
                     FontSize="11"
                     Opacity="0.75"
                     VerticalAlignment="Center" />
          <Button Classes="status-cancel"
                  Click="OnStatusOperationCancelRequested"
                  VerticalAlignment="Center">
            <Grid Width="16" Height="16">
              <Ellipse Fill="{DynamicResource AppPanelBrush}"
                       Stroke="{DynamicResource AppBorderBrush}"
                       StrokeThickness="1" />
              <TextBlock Text="X"
                         FontSize="9"
                         FontWeight="SemiBold"
                         HorizontalAlignment="Center"
                         VerticalAlignment="Center"
                         Opacity="0.85" />
            </Grid>
          </Button>
        </StackPanel>

        <!-- Right: Content metrics -->
        <StackPanel Grid.Column="2"
                    Orientation="Horizontal"
                    VerticalAlignment="Center"
                    IsVisible="{Binding StatusMetricsVisible}">
          <TextBlock Text="{Binding StatusContentLabel}"
                     FontSize="12"
                     FontWeight="SemiBold"
                     Opacity="0.9"
                     VerticalAlignment="Center" />
          <TextBlock Text=" - "
                     FontSize="12"
                     Opacity="0.6"
                     VerticalAlignment="Center" />
          <TextBlock Text="{Binding StatusContentStatsText}"
                     FontSize="12"
                     Foreground="{DynamicResource AppTextBrush}"
                     Opacity="0.88"
                     VerticalAlignment="Center" />
        </StackPanel>
      </Grid>
    </Border>

    <Grid>
      <!-- Drop zone shown when no project is loaded -->
      <Border Name="DropZoneContainer"
              Classes="drop-zone-outer"
              IsVisible="{Binding !IsProjectLoaded}"
              Background="Transparent"
              Margin="60"
              HorizontalAlignment="Stretch"
              VerticalAlignment="Stretch"
              Cursor="Hand"
              PointerPressed="OnDropZoneClick"
              DragDrop.AllowDrop="True">

        <Grid ClipToBounds="False">
          <!-- Dashed frame rendered via Rectangle -->
          <Rectangle Classes="drop-zone-border"
                     RadiusX="21.25" RadiusY="21.25"
                     StrokeThickness="2.5"
                     Stroke="{DynamicResource DropZoneBorderBrush}"
                     StrokeDashArray="8,6"
                     Margin="-1.25"
                     Fill="Transparent" />

          <!-- Soft semi-transparent background -->
          <Rectangle RadiusX="20" RadiusY="20"
                     Fill="{DynamicResource DropZoneInnerBrush}"
                     Margin="1" />

          <!-- Content -->
          <Grid RowDefinitions="*,Auto,Auto,Auto,Auto,1.7*"
                Margin="40">

            <!-- Fixed-height icon container -->
            <Border Grid.Row="1"
                    Height="115"
                    Margin="0,0,0,20"
                    Background="Transparent"
                    ClipToBounds="False">
              <!-- Folder icon with floating animation -->
              <Viewbox Name="DropZoneIcon"
                       Classes="drop-zone-icon"
                       Width="128"
                       Height="128"
                       VerticalAlignment="Bottom">
                <Canvas Width="100" Height="90">
                  <!-- Folder back shape -->
                  <Path Canvas.Left="10" Canvas.Top="15"
                        Fill="{DynamicResource DropZoneFolderBackBrush}"
                        Data="M 0,12 L 0,60 Q 0,65 5,65 L 75,65 Q 80,65 80,60 L 80,12 Q 80,7 75,7 L 32,7 L 27,0 L 5,0 Q 0,0 0,5 Z" />

                  <!-- Folder front shape -->
                  <Path Canvas.Left="10" Canvas.Top="15"
                        Fill="{DynamicResource DropZoneFolderFrontBrush}"
                        Data="M 0,22 L 0,60 Q 0,65 5,65 L 75,65 Q 80,65 80,60 L 80,22 Q 80,17 75,17 L 5,17 Q 0,17 0,22 Z" />

                  <!-- Down arrow -->
                  <Path Canvas.Left="40" Canvas.Top="28"
                        Fill="{DynamicResource DropZoneArrowBrush}"
                        Data="M 10,0 L 10,14 L 4,14 L 10,24 L 16,14 L 10,14 L 10,0 Z" />
                </Canvas>
              </Viewbox>
            </Border>

            <!-- Primary text -->
            <TextBlock Grid.Row="2"
                       Text="{Binding DropZoneTitle}"
                       FontSize="24"
                       FontWeight="SemiBold"
                       Foreground="{DynamicResource AppTextBrush}"
                       HorizontalAlignment="Center"
                       Margin="0,0,0,6" />

            <!-- Secondary text with hotkey hint -->
            <StackPanel Grid.Row="3"
                        Orientation="Horizontal"
                        HorizontalAlignment="Center"
                        Margin="0,0,0,12"
                        Spacing="8"
                        Opacity="0.7">
              <TextBlock Text="{Binding DropZoneHotkeyHint}"
                         FontSize="14"
                         Foreground="{DynamicResource AppMutedTextBrush}"
                         VerticalAlignment="Center" />
              <Border Background="{DynamicResource DropZoneKbdBrush}"
                      CornerRadius="4"
                      Height="20"
                      Padding="6,0"
                      VerticalAlignment="Center"
                      BorderBrush="{DynamicResource AppBorderBrush}"
                      BorderThickness="1">
                <TextBlock Text="Ctrl+O"
                           FontSize="11"
                           FontFamily="Consolas, monospace"
                           VerticalAlignment="Center"
                           Margin="0,5,0,0"
                           TextAlignment="Center"
                           Foreground="{DynamicResource AppMutedTextBrush}" />
              </Border>
            </StackPanel>

            <StackPanel Grid.Row="4"
                        Orientation="Horizontal"
                        HorizontalAlignment="Center"
                        Spacing="10"
                        Margin="0,16,0,0">
              <!-- Folder selection button -->
              <Button Classes="drop-zone-button primary-action"
                      Padding="24,12"
                      CornerRadius="10"
                      BorderThickness="0"
                      Cursor="Hand"
                      Click="OnOpenFolder">
                <StackPanel Orientation="Horizontal" Spacing="10">
                  <!-- Folder icon -->
                  <Path Fill="{DynamicResource PrimaryActionForegroundBrush}"
                        Width="18" Height="18"
                        Stretch="Uniform"
                        Data="M 1,3 L 1,15 L 17,15 L 17,5 L 9,5 L 7,3 Z M 2,6 L 16,6 L 16,14 L 2,14 Z" />
                  <TextBlock Text="{Binding DropZoneButtonText}"
                             FontSize="14"
                             FontWeight="SemiBold"
                             Foreground="{DynamicResource PrimaryActionForegroundBrush}"
                             VerticalAlignment="Center" />
                </StackPanel>
              </Button>

              <Button Classes="drop-zone-button primary-action"
                      Padding="20,12"
                      CornerRadius="10"
                      BorderThickness="0"
                      Cursor="Hand"
                      Click="OnGitClone">
                <TextBlock Text="{Binding DropZoneCloneButtonText}"
                           FontSize="14"
                           FontWeight="SemiBold"
                           Foreground="{DynamicResource PrimaryActionForegroundBrush}"
                           VerticalAlignment="Center" />
              </Button>
            </StackPanel>

          </Grid>
        </Grid>
      </Border>

      <!-- Project tree shown when a project is loaded -->
      <Grid ColumnDefinitions="*,Auto"
            IsVisible="{Binding IsProjectLoaded}"
            Margin="4,3,4,3">
        <DockPanel Grid.Column="0" Margin="0,0,4,0">
          <!-- Animated search bar container - only pushes tree down, not settings -->
          <Border DockPanel.Dock="Top"
                  Name="SearchBarContainer"
                  ClipToBounds="True"
                  Height="0">
            <views:SearchBarView Name="SearchBar"
                                 RenderTransformOrigin="50%,0%"
                                 SearchKeyDown="OnSearchKeyDown"
                                 SearchPrevRequested="OnSearchPrev"
                                 SearchNextRequested="OnSearchNext"
                                 SearchCloseRequested="OnSearchClose">
              <views:SearchBarView.RenderTransform>
                <TranslateTransform Y="0" />
              </views:SearchBarView.RenderTransform>
            </views:SearchBarView>
          </Border>

          <!-- Animated filter bar container - only pushes tree down, not settings -->
          <Border DockPanel.Dock="Top"
                  Name="FilterBarContainer"
                  ClipToBounds="True"
                  Height="0">
            <views:FilterBarView Name="FilterBar"
                                 RenderTransformOrigin="50%,0%"
                                 FilterKeyDown="OnFilterKeyDown"
                                 FilterCloseRequested="OnFilterClose">
              <views:FilterBarView.RenderTransform>
                <TranslateTransform Y="0" />
              </views:FilterBarView.RenderTransform>
            </views:FilterBarView>
          </Border>

          <!-- Animated preview bar container -->
          <Border DockPanel.Dock="Top"
                  Name="PreviewBarContainer"
                  ClipToBounds="True"
                  Height="0">
            <Border Name="PreviewBar"
                    Classes="preview-panel"
                    RenderTransformOrigin="50%,0%">
              <Border.RenderTransform>
                <TranslateTransform Y="0" />
              </Border.RenderTransform>
              <Grid ColumnDefinitions="Auto,*,Auto"
                    Margin="12,4"
                    VerticalAlignment="Center">
                <!-- Left spacer keeps segmented control visually centered against the close button. -->
                <Border Grid.Column="0"
                        Width="44"
                        Background="Transparent" />

                <Border Grid.Column="1"
                        Classes="segmented-control preview-segmented-control">
                  <Panel>
                    <Border Name="PreviewSegmentThumb"
                            Classes="segment-thumb preview-segment-thumb"
                            HorizontalAlignment="Left"
                            VerticalAlignment="Stretch"
                            Classes.preview-segment-thumb-middle="{Binding IsPreviewContentSelected}"
                            Classes.preview-segment-thumb-right="{Binding IsPreviewTreeAndContentSelected}" />

                    <StackPanel Orientation="Horizontal">
                      <Button Classes="segment-text-button preview-segment-button"
                              Classes.segment-selected="{Binding IsPreviewTreeSelected}"
                              Content="{Binding PreviewModeTree}"
                              Click="OnPreviewTreeModeClick" />
                      <Button Classes="segment-text-button preview-segment-button"
                              Classes.segment-selected="{Binding IsPreviewContentSelected}"
                              Content="{Binding PreviewModeContent}"
                              Click="OnPreviewContentModeClick" />
                      <Button Classes="segment-text-button preview-segment-button"
                              Classes.segment-selected="{Binding IsPreviewTreeAndContentSelected}"
                              Content="{Binding PreviewModeTreeAndContent}"
                              Click="OnPreviewTreeAndContentModeClick" />
                    </StackPanel>
                  </Panel>
                </Border>
                <Button Grid.Column="2"
                        Classes="menu-icon-button preview-close-button"
                        Width="32"
                        Height="32"
                        Margin="12,0,0,0"
                        Content="âœ•"
                        Click="OnPreviewClose" />
              </Grid>
            </Border>
          </Border>

          <!-- Tree content island -->
          <Border Classes="island-panel content-island">
            <Grid>
              <TreeView Name="ProjectTree"
                        Grid.Column="0"
                        ItemsSource="{Binding TreeNodes}"
                        IsEnabled="{Binding IsProjectLoaded}"
                        IsVisible="{Binding !IsPreviewMode}"
                        FontFamily="{Binding SelectedFontFamily}"
                        FontSize="{Binding TreeFontSize}">
                <TreeView.ItemsPanel>
                  <ItemsPanelTemplate>
                    <VirtualizingStackPanel CacheLength="2" />
                  </ItemsPanelTemplate>
                </TreeView.ItemsPanel>
                <TreeView.ItemTemplate>
                  <TreeDataTemplate x:DataType="vm:TreeNodeViewModel"
                                    ItemsSource="{CompiledBinding ChildItemsSource}">
                    <Grid ColumnDefinitions="Auto,*" Background="Transparent">
                      <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="{Binding Level, RelativeSource={RelativeSource AncestorType=TreeViewItem}, Converter={StaticResource TreeIndentConverter}}" />
                        <ColumnDefinition Width="*" />
                      </Grid.ColumnDefinitions>
                      <StackPanel Grid.Column="1"
                                  Orientation="Horizontal"
                                  Background="Transparent"
                                  Spacing="{Binding DataContext.TreeItemSpacing, RelativeSource={RelativeSource AncestorType=TreeView}}">
                        <CheckBox IsThreeState="True"
                                  IsChecked="{CompiledBinding IsChecked, Mode=TwoWay}"
                                  VerticalAlignment="Center" />
                        <Image Source="{CompiledBinding Icon}"
                               Width="{Binding DataContext.TreeIconSize, RelativeSource={RelativeSource AncestorType=TreeView}}"
                               Height="{Binding DataContext.TreeIconSize, RelativeSource={RelativeSource AncestorType=TreeView}}"
                               Stretch="Uniform"
                               VerticalAlignment="Center" />
                        <TextBlock Text="{CompiledBinding DisplayName}"
                                   IsVisible="{Binding !HasHighlightedDisplay}"
                                   VerticalAlignment="Center"
                                   Margin="{Binding DataContext.TreeTextMargin, RelativeSource={RelativeSource AncestorType=TreeView}}"
                                   FontFamily="{Binding DataContext.SelectedFontFamily, RelativeSource={RelativeSource AncestorType=TreeView}}"
                                   FontSize="{Binding DataContext.TreeFontSize, RelativeSource={RelativeSource AncestorType=TreeView}}"
                                   Foreground="{DynamicResource AppTextBrush}" />
                        <TextBlock Inlines="{CompiledBinding DisplayInlines}"
                                   IsVisible="{Binding HasHighlightedDisplay}"
                                   VerticalAlignment="Center"
                                   Margin="{Binding DataContext.TreeTextMargin, RelativeSource={RelativeSource AncestorType=TreeView}}"
                                   FontFamily="{Binding DataContext.SelectedFontFamily, RelativeSource={RelativeSource AncestorType=TreeView}}"
                                   FontSize="{Binding DataContext.TreeFontSize, RelativeSource={RelativeSource AncestorType=TreeView}}"
                                   Foreground="{DynamicResource AppTextBrush}" />
                      </StackPanel>
                    </Grid>
                  </TreeDataTemplate>
                </TreeView.ItemTemplate>
              </TreeView>

              <Border IsVisible="{Binding IsPreviewMode}"
                      Background="Transparent">
                <Grid>
                  <Grid Margin="0,6,0,0" ColumnDefinitions="Auto,*">
                    <!-- Persistent line-number background that spans the full preview height -->
                    <Grid Grid.Column="0">
                      <Border Name="PreviewLineNumbersBackground"
                              Classes="preview-line-numbers"
                              Margin="0,-6,0,0"
                              Width="{Binding Bounds.Width, ElementName=PreviewLineNumbersHost}" />
                      <ScrollViewer Name="PreviewLineNumbersScrollViewer"
                                    HorizontalScrollBarVisibility="Disabled"
                                    VerticalScrollBarVisibility="Hidden"
                                    IsHitTestVisible="False">
                        <Border Name="PreviewLineNumbersHost"
                                Background="Transparent"
                                Padding="10,10,8,10">
                          <TextBlock Text="{Binding PreviewLineNumbers}"
                                     FontFamily="{Binding SelectedFontFamily}"
                                     FontSize="{Binding TreeFontSize}"
                                     Opacity="0.72"
                                     Margin="0"
                                     TextWrapping="NoWrap" />
                        </Border>
                      </ScrollViewer>
                    </Grid>

                    <ScrollViewer Grid.Column="1"
                                  Name="PreviewTextScrollViewer"
                                  Margin="0,0,0,8"
                                  HorizontalScrollBarVisibility="Auto"
                                  VerticalScrollBarVisibility="Auto"
                                  ScrollChanged="OnPreviewTextScrollChanged">
                      <Border Padding="10,10,16,10">
                        <TextBlock Text="{Binding PreviewText}"
                                   FontFamily="{Binding SelectedFontFamily}"
                                   FontSize="{Binding TreeFontSize}"
                                   TextWrapping="NoWrap"
                                   HorizontalAlignment="Left"
                                   VerticalAlignment="Top" />
                      </Border>
                    </ScrollViewer>
                  </Grid>
                </Grid>
              </Border>
            </Grid>
          </Border>
        </DockPanel>

        <!-- Animated settings panel container -->
        <Border Grid.Column="1"
                Name="SettingsContainer"
                ClipToBounds="True"
                IsVisible="{Binding IsProjectLoaded}">
          <Border Classes="island-panel settings-island"
                  Name="SettingsIsland"
                  RenderTransformOrigin="100%,50%">
            <Border.RenderTransform>
              <TranslateTransform X="0" />
            </Border.RenderTransform>
            <!-- Settings panel -->
            <views:SettingsPanelView Name="SettingsPanel"
                                     ApplySettingsRequested="OnApplySettings"
                                     IgnoreAllChanged="OnIgnoreAllChanged"
                                     ExtensionsAllChanged="OnExtensionsAllChanged"
                                     RootAllChanged="OnRootAllChanged" />
          </Border>
        </Border>
      </Grid>

      <ItemsControl ItemsSource="{Binding ToastItems}"
                    IsHitTestVisible="False"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Bottom"
                    Margin="0,0,0,38">
        <ItemsControl.ItemsPanel>
          <ItemsPanelTemplate>
            <StackPanel Spacing="8" />
          </ItemsPanelTemplate>
        </ItemsControl.ItemsPanel>
        <ItemsControl.ItemTemplate>
          <DataTemplate>
            <Border Background="{DynamicResource AppPanelBrush}"
                    CornerRadius="8"
                    Padding="14,10"
                    Opacity="{Binding Opacity}"
                    MaxWidth="420"
                    HorizontalAlignment="Center"
                    BorderBrush="{DynamicResource AppBorderBrush}"
                    BorderThickness="1">
              <Border.Transitions>
                <Transitions>
                  <DoubleTransition Property="Opacity" Duration="0:0:0.2" />
                </Transitions>
              </Border.Transitions>
              <Border.RenderTransform>
                <TranslateTransform Y="{Binding OffsetY}">
                  <TranslateTransform.Transitions>
                    <Transitions>
                      <DoubleTransition Property="Y" Duration="0:0:0.2" />
                    </Transitions>
                  </TranslateTransform.Transitions>
                </TranslateTransform>
              </Border.RenderTransform>
              <TextBlock Text="{Binding Message}"
                         TextWrapping="Wrap"
                         FontSize="14"
                         Foreground="{DynamicResource AppTextBrush}" />
            </Border>
          </DataTemplate>
        </ItemsControl.ItemTemplate>
      </ItemsControl>
    </Grid>
  </DockPanel>
</Window>
